<div class="drif-project-container" *transloco="let t; read: 'project'">
  <mat-card *ngIf="!!project">
    <mat-card-header>
      <mat-card-title-group>
        <mat-card-title>{{ project.projectTitle }}</mat-card-title>
        <button
          mat-stroked-button
          color="primary"
          [routerLink]="[projectsRoute]"
        >
          Back
        </button>
        <mat-card-subtitle>for {{ project.proponentName }}</mat-card-subtitle>
      </mat-card-title-group>
    </mat-card-header>
    <mat-card-content class="drif-project-details">
      <div>
        <h5 style="margin-left: 1rem">Project Details</h5>

        <div class="project-details-table">
          <div>
            <strong>ID: </strong>
            {{ projectId }}
          </div>
          <div>
            <strong>Funding Program: </strong
            >{{ project.programType | transloco }}
          </div>

          <div>
            <strong>Reporting Schedule: </strong
            >{{ t(project.reportingScheduleType!) }}
          </div>

          <div>
            <strong>Planned Start Date: </strong
            >{{ project.startDate | date: "yyyy-MM-dd" }}
          </div>

          <div>
            <strong>EOI: </strong>
            <a [routerLink]="['/eoi-submission-details', project.eoiId]">{{
              project.eoiId
            }}</a>
          </div>

          <div><strong>Contract ID: </strong>{{ project.contractNumber }}</div>
          <div>
            <strong>Project Type: </strong>{{ t(project.fundingStream!) }}
          </div>

          <div>
            <strong>Funding Amount: </strong
            >{{ project.fundingAmount | currency: "" : "symbol" : "1.0-0" }}
          </div>

          <div>
            <strong>Planned End Date: </strong
            >{{ project.endDate | date: "yyyy-MM-dd" }}
          </div>

          <div>
            <strong>Full Proposal: </strong
            ><a [routerLink]="['/fp-submission-details', project.fpId]">{{
              project.fpId
            }}</a>
          </div>

          <div><strong>Project Status: </strong>{{ t(project.status!) }}</div>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem">
        <div>
          <h5 style="margin-left: 1rem">Conditions</h5>
          <table
            mat-table
            [dataSource]="conditionsDataSource"
            multiTemplateDataRows
          >
            <ng-container matColumnDef="conditionName">
              <th mat-header-cell *matHeaderCellDef>Condition</th>
              <td mat-cell *matCellDef="let condition">
                {{ condition.conditionName }}
              </td>
            </ng-container>
            <ng-container matColumnDef="limit">
              <th mat-header-cell *matHeaderCellDef>Limit</th>
              <td mat-cell *matCellDef="let condition">
                {{ condition.limit }}%
              </td>
            </ng-container>
            <ng-container matColumnDef="conditionMet">
              <th mat-header-cell *matHeaderCellDef>Condition Met?</th>
              <td mat-cell *matCellDef="let condition">
                {{ condition.conditionMet ? "Yes" : "No" }}
              </td>
            </ng-container>
            <ng-container matColumnDef="dateMet">
              <th mat-header-cell *matHeaderCellDef>Date Met</th>
              <td mat-cell *matCellDef="let condition">
                {{ condition.dateMet | date: "yyyy-MM-dd" }}
              </td>
            </ng-container>
            <tr
              mat-header-row
              *matHeaderRowDef="[
                'conditionName',
                'limit',
                'conditionMet',
                'dateMet',
              ]"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                columns: ['conditionName', 'limit', 'conditionMet', 'dateMet']
              "
            ></tr>
          </table>
        </div>
        <div>
          <h5 style="margin-left: 1rem">Cost Projections</h5>
          <table
            mat-table
            [dataSource]="costProjectionsDataSource"
            multiTemplateDataRows
          >
            <ng-container matColumnDef="fiscalYear">
              <th mat-header-cell *matHeaderCellDef>Fiscal Year</th>
              <td mat-cell *matCellDef="let costProjection">
                {{ costProjection.fiscalYear }}
              </td>
            </ng-container>
            <ng-container matColumnDef="originalForecast">
              <th mat-header-cell *matHeaderCellDef>Original Forecast</th>
              <td mat-cell *matCellDef="let costProjection">
                {{ costProjection.originalForecast | currency }}
              </td>
            </ng-container>
            <ng-container matColumnDef="currentForecast">
              <th mat-header-cell *matHeaderCellDef>Current Forecast</th>
              <td mat-cell *matCellDef="let costProjection">
                {{ costProjection.currentForecast | currency }}
              </td>
            </ng-container>
            <tr
              mat-header-row
              *matHeaderRowDef="[
                'fiscalYear',
                'originalForecast',
                'currentForecast',
              ]"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                columns: ['fiscalYear', 'originalForecast', 'currentForecast']
              "
            ></tr>
          </table>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-tab-group>
    <mat-tab label="Reports Due">
      <mat-card class="tab-mat-card">
        <button
          style="align-self: start"
          mat-raised-button
          color="primary"
          (click)="addInterimReport()"
        >
          {{ t("startNextReport") }}
        </button>

        <table
          mat-table
          [dataSource]="interimReportsDataSource"
          multiTemplateDataRows
        >
          <ng-container matColumnDef="report">
            <th mat-header-cell *matHeaderCellDef>Report</th>
            <td mat-cell *matCellDef="let element">
              @if (!element.parentId) {
                {{ element.name }}
              }
            </td>
          </ng-container>
          <ng-container matColumnDef="section">
            <th mat-header-cell *matHeaderCellDef>Section</th>
            <td mat-cell *matCellDef="let element">
              {{ element.section }}
            </td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let element">
              {{ element.status | transloco }}
            </td>
          </ng-container>
          <ng-container matColumnDef="dueDate">
            <th mat-header-cell *matHeaderCellDef>Due Date</th>
            <td mat-cell *matCellDef="let element">
              {{ element.dueDate | date: "yyyy-MM-dd" }}
            </td>
          </ng-container>

          <ng-container matColumnDef="submittedDate">
            <th mat-header-cell *matHeaderCellDef>Submitted Date</th>
            <td mat-cell *matCellDef="let element">
              {{ element.submittedDate | date: "yyyy-MM-dd" }}
            </td>
          </ng-container>

          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let element">
              @if (element.parentId) {
                <div class="table-actions">
                  <a
                    *ngFor="let action of element.actions"
                    mat-raised-button
                    color="primary"
                    [routerLink]="getSubReportRoute(element, action)"
                  >
                    {{ t(action) }}
                  </a>
                </div>
              }
            </td>
          </ng-container>

          <tr
            mat-header-row
            *matHeaderRowDef="[
              'report',
              'section',
              'status',
              'dueDate',
              'submittedDate',
              'actions',
            ]"
          ></tr>
          <tr
            mat-row
            *matRowDef="
              let element;
              columns: [
                'report',
                'section',
                'status',
                'dueDate',
                'submittedDate',
                'actions',
              ]
            "
          ></tr>
        </table>
      </mat-card>
    </mat-tab>

    <mat-tab label="Conditions">
      <mat-card class="tab-mat-card">
        <table class="drr-table" mat-table [dataSource]="conditionsDataSource">
          <ng-container matColumnDef="conditionName">
            <th mat-header-cell *matHeaderCellDef>Condition</th>
            <td mat-cell *matCellDef="let condition">
              {{ condition.conditionName }}
            </td>
          </ng-container>
          <ng-container matColumnDef="limit">
            <th mat-header-cell *matHeaderCellDef>Limit</th>
            <td mat-cell *matCellDef="let condition">{{ condition.limit }}%</td>
          </ng-container>
          <ng-container matColumnDef="conditionMet">
            <th mat-header-cell *matHeaderCellDef>Condition Met?</th>
            <td mat-cell *matCellDef="let condition">
              {{ condition.conditionMet ? "Yes" : "No" }}
            </td>
          </ng-container>
          <ng-container matColumnDef="dateMet">
            <th mat-header-cell *matHeaderCellDef>Date Met</th>
            <td mat-cell *matCellDef="let condition">
              {{ condition.dateMet | date: "yyyy-MM-dd" }}
            </td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef style="text-align: center">
              Actions
            </th>
            <td mat-cell *matCellDef="let condition">
              <div class="table-actions">
                @if (condition.conditionMet) {
                  <!-- TODO: details view link -->
                } @else {
                  <a
                    mat-raised-button
                    color="primary"
                    [routerLink]="[
                      '/drif-projects',
                      projectId,
                      'conditions',
                      condition.id,
                      'clear',
                    ]"
                  >
                    Clear
                  </a>
                }
              </div>
            </td>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="[
              'conditionName',
              'limit',
              'conditionMet',
              'dateMet',
            ]"
          ></tr>
          <tr
            mat-row
            *matRowDef="
              let row;
              columns: ['conditionName', 'limit', 'conditionMet', 'dateMet']
            "
          ></tr>
        </table>
      </mat-card>
    </mat-tab>

    <mat-tab label="Key Documents">
      <mat-card class="tab-mat-card">
        <table mat-table [dataSource]="attachmentsDataSource">
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let attachment">{{ attachment.id }}</td>
          </ng-container>
          <ng-container matColumnDef="fileName">
            <th mat-header-cell *matHeaderCellDef>File Name</th>
            <td mat-cell *matCellDef="let attachment">
              {{ attachment.fileName }}
            </td>
          </ng-container>
          <ng-container matColumnDef="fileType">
            <th mat-header-cell *matHeaderCellDef>File Type</th>
            <td mat-cell *matCellDef="let attachment">
              {{ attachment.fileType }}
            </td>
          </ng-container>
          <ng-container matColumnDef="fileSize">
            <th mat-header-cell *matHeaderCellDef>File Size</th>
            <td mat-cell *matCellDef="let attachment">
              {{ attachment.fileSize }}
            </td>
          </ng-container>
          <ng-container matColumnDef="uploadDate">
            <th mat-header-cell *matHeaderCellDef>Upload Date</th>
            <td mat-cell *matCellDef="let attachment">
              {{ attachment.uploadDate }}
            </td>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="[
              'id',
              'fileName',
              'fileType',
              'fileSize',
              'uploadDate',
            ]"
          ></tr>
          <tr
            mat-row
            *matRowDef="
              let row;
              columns: ['id', 'fileName', 'fileType', 'fileSize', 'uploadDate']
            "
          ></tr>
        </table>
      </mat-card>
    </mat-tab>

    <mat-tab label="Contacts">
      <mat-card class="tab-mat-card">
        <button
          style="align-self: start"
          mat-raised-button
          color="primary"
          (click)="addProjectContact()"
        >
          {{ t("addProjectContact") }}
        </button>

        <table mat-table [dataSource]="projectContactsDataSource">
          <ng-container matColumnDef="firstName">
            <th mat-header-cell *matHeaderCellDef>First Name</th>
            <td mat-cell *matCellDef="let contact">{{ contact.firstName }}</td>
          </ng-container>
          <ng-container matColumnDef="lastName">
            <th mat-header-cell *matHeaderCellDef>Last Name</th>
            <td mat-cell *matCellDef="let contact">{{ contact.lastName }}</td>
          </ng-container>
          <ng-container matColumnDef="title">
            <th mat-header-cell *matHeaderCellDef>Title</th>
            <td mat-cell *matCellDef="let contact">{{ contact.title }}</td>
          </ng-container>
          <ng-container matColumnDef="department">
            <th mat-header-cell *matHeaderCellDef>Department</th>
            <td mat-cell *matCellDef="let contact">{{ contact.department }}</td>
          </ng-container>
          <ng-container matColumnDef="phone">
            <th mat-header-cell *matHeaderCellDef>Phone</th>
            <td mat-cell *matCellDef="let contact">{{ contact.phone }}</td>
          </ng-container>
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let contact">{{ contact.email }}</td>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="[
              'firstName',
              'lastName',
              'title',
              'department',
              'phone',
              'email',
            ]"
          ></tr>
          <tr
            mat-row
            *matRowDef="
              let row;
              columns: [
                'firstName',
                'lastName',
                'title',
                'department',
                'phone',
                'email',
              ]
            "
          ></tr>
        </table>
      </mat-card>
    </mat-tab>

    <mat-tab label="Completed Reports">
      <mat-card class="tab-mat-card">
        <table mat-table [dataSource]="pastReportsDataSource">
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let report">{{ report.id }}</td>
          </ng-container>
          <ng-container matColumnDef="dueDate">
            <th mat-header-cell *matHeaderCellDef>Due Date</th>
            <td mat-cell *matCellDef="let report">
              {{ report.dueDate | date: "yyyy-MM-dd" }}
            </td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let report">{{ report.status }}</td>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="['id', 'dueDate', 'status']"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: ['id', 'dueDate', 'status']"
          ></tr>
        </table>
      </mat-card>
    </mat-tab>
  </mat-tab-group>
</div>
