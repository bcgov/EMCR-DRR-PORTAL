<div class="drif-project-container" *transloco="let t; read: 'project'">
  <mat-card>
    <mat-card-header>
      <mat-card-title-group>
        <mat-card-title>{{ project?.projectTitle }}</mat-card-title>
        <div>
          <i> Status: </i>
          <mat-chip>
            {{ project?.status }}
          </mat-chip>
        </div>
        <mat-card-subtitle>{{ project?.proponentName }}</mat-card-subtitle>
      </mat-card-title-group>
    </mat-card-header>
    <mat-card-content class="drif-project-details">
      <div
        style="
          display: flex;
          flex-direction: column;
          align-self: start;
          gap: 2rem;
        "
      >
        <div>
          <p>
            <strong>Project ID:</strong>
            {{ project?.id }}
          </p>
          <p>
            <strong>Contract ID:</strong>
            {{ project?.contractNumber }}
          </p>
        </div>
        <div>
          <p>
            <strong> Funding Program: </strong>
            {{ project?.programType | transloco }}
          </p>
          <p>
            <strong>Project Type:</strong>
            {{ t(project?.fundingStream!) }}
          </p>
          <p>
            <strong>Reporting Schedule:</strong>
            {{ t(project?.reportingScheduleType!) }}
          </p>
        </div>
        <div>
          <p>
            <strong>EOI:</strong><a href=""> {{ project?.eoiId }} </a>
          </p>
          <p>
            <strong>Full Proposal:</strong><a href=""> {{ project?.fpId }} </a>
          </p>
        </div>
      </div>
      <div style="align-self: start">
        <p>
          <strong>Planned Start Date:</strong>
          {{ project?.startDate | date : "yyyy-MM-dd" }}
        </p>
        <p>
          <strong>Planned Start Date:</strong>
          {{ project?.endDate | date : "yyyy-MM-dd" }}
        </p>
      </div>
      <div>
        <p style="margin-left: 1rem">
          <strong>Conditions</strong>
        </p>
        <table
          mat-table
          [dataSource]="conditionsDataSource"
          multiTemplateDataRows
        >
          <ng-container matColumnDef="conditionName">
            <th mat-header-cell *matHeaderCellDef>Condition</th>
            <td mat-cell *matCellDef="let condition">
              {{ condition.conditionName }}
            </td>
          </ng-container>
          <ng-container matColumnDef="limit">
            <th mat-header-cell *matHeaderCellDef>Limit</th>
            <td mat-cell *matCellDef="let condition">{{ condition.limit }}%</td>
          </ng-container>
          <ng-container matColumnDef="conditionMet">
            <th mat-header-cell *matHeaderCellDef>Condition Met?</th>
            <td mat-cell *matCellDef="let condition">
              {{ condition.conditionMet ? "Yes" : "No" }}
            </td>
          </ng-container>
          <ng-container matColumnDef="dateMet">
            <th mat-header-cell *matHeaderCellDef>Date Met</th>
            <td mat-cell *matCellDef="let condition">
              {{ condition.dateMet | date : "yyyy-MM-dd" }}
            </td>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="[
              'conditionName',
              'limit',
              'conditionMet',
              'dateMet'
            ]"
          ></tr>
          <tr
            mat-row
            *matRowDef="
              let row;
              columns: ['conditionName', 'limit', 'conditionMet', 'dateMet']
            "
          ></tr>
        </table>
        <p style="text-align: end">
          <strong>Funding Amount</strong>
          {{ project?.fundingAmount | currency : "" : "symbol" : "1.0-0" }}
        </p>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-tab-group>
    <mat-tab label="Reports Due">
      <div>
        <div
          style="
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 1rem;
            padding: 1rem;
          "
        >
          <table
            mat-table
            [dataSource]="interimReportsDataSource"
            multiTemplateDataRows
          >
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef>ID</th>
              <td mat-cell *matCellDef="let element">
                {{ element.id }}
              </td>
            </ng-container>
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let element">
                {{ element.status | transloco }}
              </td>
            </ng-container>
            <ng-container matColumnDef="dueDate">
              <th mat-header-cell *matHeaderCellDef>Due Date</th>
              <td mat-cell *matCellDef="let element">
                {{ element.dueDate | date : "yyyy-MM-dd" }}
              </td>
            </ng-container>

            <ng-container matColumnDef="submitDate">
              <th mat-header-cell *matHeaderCellDef>Submitted Date</th>
              <td mat-cell *matCellDef="let element">
                {{ element.submitDate | date : "yyyy-MM-dd" }}
              </td>
            </ng-container>

            <ng-container matColumnDef="expand">
              <th mat-header-cell *matHeaderCellDef aria-label="row actions">
                &nbsp;
              </th>
              <td mat-cell *matCellDef="let element" style="text-align: right">
                <button
                  mat-icon-button
                  aria-label="expand row"
                  (click)="
                    expandedInterimReport =
                      expandedInterimReport === element ? null : element;
                    $event.stopPropagation()
                  "
                >
                  @if (expandedInterimReport === element) {
                  <mat-icon>keyboard_arrow_up</mat-icon>
                  } @else {
                  <mat-icon>keyboard_arrow_down</mat-icon>
                  }
                </button>
              </td>
            </ng-container>

            <ng-container matColumnDef="expandedDetail">
              <td
                mat-cell
                *matCellDef="let element"
                [attr.colspan]="5"
                style="padding: 0"
              >
                <div
                  class="interim-element-detail"
                  [@detailExpand]="
                    element == expandedInterimReport ? 'expanded' : 'collapsed'
                  "
                >
                  <mat-card>
                    <div class="interim-element-detail-container">
                      <div class="interim-element-detail-container__info">
                        <b>Claim</b>
                        @if (element.projectClaim) {
                        <div>
                          Claim ID:
                          <a
                            [routerLink]="[
                              '/drif-projects',
                              projectId,
                              'interim-reports',
                              element.id,
                              'claims',
                              element.projectClaim.id
                            ]"
                            >{{ element.projectClaim.id }}</a
                          >
                        </div>
                        <div>
                          Due Date: {{ element.projectClaim.claimDate }}
                        </div>
                        <div>Status: {{ element.projectClaim.status }}</div>
                        } @else {
                        <div>
                          <i>No claim associated with this report</i>
                        </div>
                        }
                      </div>
                      @if (element.projectClaim) {
                      <div class="interim-element-detail-container__actions">
                        <a
                          mat-raised-button
                          color="primary"
                          [routerLink]="[
                            '/drif-projects',
                            projectId,
                            'interim-reports',
                            element.id,
                            'claims',
                            element.projectClaim.id,
                            'edit'
                          ]"
                          >Edit</a
                        >
                      </div>
                      }
                    </div>

                    <mat-divider></mat-divider>

                    <div class="interim-element-detail-container">
                      <div class="interim-element-detail-container__info">
                        <b>Progress Report</b>
                        @if (element.progressReport) {
                        <div>
                          Report ID:
                          <a
                            [routerLink]="[
                              '/drif-projects',
                              projectId,
                              'interim-reports',
                              element.id,
                              'progress-reports',
                              element.progressReport.id
                            ]"
                            >{{ element.progressReport.id }}</a
                          >
                        </div>
                        <div>
                          Due Date: {{ element.progressReport.reportDate }}
                        </div>
                        <div>Status: {{ element.progressReport.status }}</div>
                        } @else {
                        <div>
                          <i>No progress report associated with this report</i>
                        </div>
                        }
                      </div>
                      @if (element.progressReport) {
                      <div class="interim-element-detail-container__actions">
                        <a
                          mat-raised-button
                          color="primary"
                          [routerLink]="[
                            '/drif-projects',
                            projectId,
                            'interim-reports',
                            element.id,
                            'progress-reports',
                            element.progressReport.id,
                            'edit'
                          ]"
                        >
                          Edit
                        </a>
                      </div>
                      }
                    </div>

                    <mat-divider></mat-divider>

                    <div class="interim-element-detail-container">
                      <div class="interim-element-detail-container__info">
                        <b>Forecast</b>
                        @if (element.forecast) {
                        <div>
                          Forecast ID:
                          <a
                            [routerLink]="[
                              '/drif-projects',
                              projectId,
                              'interim-reports',
                              element.id,
                              'forecasts',
                              element.forecast.id
                            ]"
                            >{{ element.forecast.id }}</a
                          >
                        </div>
                        <div>Due Date: {{ element.forecast.forecastDate }}</div>
                        <div>Status: {{ element.forecast.status }}</div>
                        } @else {
                        <div>
                          <i>No forecast associated with this report</i>
                        </div>
                        }
                      </div>
                      @if (element.forecast) {
                      <div class="interim-element-detail-container__actions">
                        <a
                          mat-raised-button
                          color="primary"
                          [routerLink]="[
                            '/drif-projects',
                            projectId,
                            'interim-reports',
                            element.id,
                            'forecasts',
                            element.forecast.id,
                            'edit'
                          ]"
                          >Edit</a
                        >
                      </div>
                      }
                    </div>
                  </mat-card>
                </div>
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="[
                'id',
                'status',
                'dueDate',
                'submitDate',
                'expand'
              ]"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let element;
                columns: ['id', 'status', 'dueDate', 'submitDate', 'expand']
              "
              class="interim-element-row"
              [class.interim-expanded-row]="expandedInterimReport === element"
              (click)="
                expandedInterimReport =
                  expandedInterimReport === element ? null : element
              "
            ></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: ['expandedDetail']"
              class="interim-detail-row"
            ></tr>
          </table>
          <div style="display: flex; flex-direction: column; gap: 1rem">
            <button
              mat-raised-button
              color="primary"
              (click)="addInterimReport()"
            >
              {{ t("startNextReport") }}
            </button>
          </div>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Conditions">
      <mat-card>
        <!-- <mat-card-header>
          <mat-card-title>Claims</mat-card-title>
        </mat-card-header> -->
        <table class="drr-table" mat-table [dataSource]="conditionsDataSource">
          <ng-container matColumnDef="conditionName">
            <th mat-header-cell *matHeaderCellDef>Condition</th>
            <td mat-cell *matCellDef="let condition">
              {{ condition.conditionName }}
            </td>
          </ng-container>
          <ng-container matColumnDef="limit">
            <th mat-header-cell *matHeaderCellDef>Limit</th>
            <td mat-cell *matCellDef="let condition">{{ condition.limit }}%</td>
          </ng-container>
          <ng-container matColumnDef="conditionMet">
            <th mat-header-cell *matHeaderCellDef>Condition Met?</th>
            <td mat-cell *matCellDef="let condition">
              {{ condition.conditionMet }}
            </td>
          </ng-container>
          <ng-container matColumnDef="dateMet">
            <th mat-header-cell *matHeaderCellDef>Date Met</th>
            <td mat-cell *matCellDef="let condition">
              {{ condition.dateMet }}
            </td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef style="text-align: center">
              Actions
            </th>
            <td mat-cell *matCellDef="let condition">
              <div class="table-actions">
                <button mat-button color="primary" (click)="viewCondition()">
                  Check details
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  (click)="clearCondition()"
                >
                  Clear
                </button>
              </div>
            </td>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="[
              'conditionName',
              'limit',
              'conditionMet',
              'dateMet',
              'actions'
            ]"
          ></tr>
          <tr
            mat-row
            *matRowDef="
              let row;
              columns: [
                'conditionName',
                'limit',
                'conditionMet',
                'dateMet',
                'actions'
              ]
            "
          ></tr>
        </table>
      </mat-card>
    </mat-tab>
    <mat-tab label="Key Documents">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Key Documents</mat-card-title>
        </mat-card-header>
        <table mat-table [dataSource]="attachmentsDataSource">
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let attachment">{{ attachment.id }}</td>
          </ng-container>
          <ng-container matColumnDef="fileName">
            <th mat-header-cell *matHeaderCellDef>File Name</th>
            <td mat-cell *matCellDef="let attachment">
              {{ attachment.fileName }}
            </td>
          </ng-container>
          <ng-container matColumnDef="fileType">
            <th mat-header-cell *matHeaderCellDef>File Type</th>
            <td mat-cell *matCellDef="let attachment">
              {{ attachment.fileType }}
            </td>
          </ng-container>
          <ng-container matColumnDef="fileSize">
            <th mat-header-cell *matHeaderCellDef>File Size</th>
            <td mat-cell *matCellDef="let attachment">
              {{ attachment.fileSize }}
            </td>
          </ng-container>
          <ng-container matColumnDef="uploadDate">
            <th mat-header-cell *matHeaderCellDef>Upload Date</th>
            <td mat-cell *matCellDef="let attachment">
              {{ attachment.uploadDate }}
            </td>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="[
              'id',
              'fileName',
              'fileType',
              'fileSize',
              'uploadDate'
            ]"
          ></tr>
          <tr
            mat-row
            *matRowDef="
              let row;
              columns: ['id', 'fileName', 'fileType', 'fileSize', 'uploadDate']
            "
          ></tr>
        </table>
      </mat-card>
    </mat-tab>
    <mat-tab label="Contacts">
      <mat-card>
        <mat-card-header>
          <mat-card-title-group>
            <mat-card-title>Project Contacts</mat-card-title>
            <button
              mat-raised-button
              color="primary"
              (click)="addProjectContact()"
            >
              {{ t("addProjectContact") }}
            </button>
          </mat-card-title-group>
        </mat-card-header>
        <table mat-table [dataSource]="projectContactsDataSource">
          <ng-container matColumnDef="firstName">
            <th mat-header-cell *matHeaderCellDef>First Name</th>
            <td mat-cell *matCellDef="let contact">{{ contact.firstName }}</td>
          </ng-container>
          <ng-container matColumnDef="lastName">
            <th mat-header-cell *matHeaderCellDef>Last Name</th>
            <td mat-cell *matCellDef="let contact">{{ contact.lastName }}</td>
          </ng-container>
          <ng-container matColumnDef="title">
            <th mat-header-cell *matHeaderCellDef>Title</th>
            <td mat-cell *matCellDef="let contact">{{ contact.title }}</td>
          </ng-container>
          <ng-container matColumnDef="department">
            <th mat-header-cell *matHeaderCellDef>Department</th>
            <td mat-cell *matCellDef="let contact">{{ contact.department }}</td>
          </ng-container>
          <ng-container matColumnDef="phone">
            <th mat-header-cell *matHeaderCellDef>Phone</th>
            <td mat-cell *matCellDef="let contact">{{ contact.phone }}</td>
          </ng-container>
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let contact">{{ contact.email }}</td>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="[
              'firstName',
              'lastName',
              'title',
              'department',
              'phone',
              'email'
            ]"
          ></tr>
          <tr
            mat-row
            *matRowDef="
              let row;
              columns: [
                'firstName',
                'lastName',
                'title',
                'department',
                'phone',
                'email'
              ]
            "
          ></tr>
        </table>
      </mat-card>
    </mat-tab>
    <mat-tab label="Completed Reports">
      <mat-card>
        <!-- <mat-card-header>
          <mat-card-title>Past Reports</mat-card-title>
        </mat-card-header> -->
        <table mat-table [dataSource]="pastReportsDataSource">
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let report">
              <a
                [routerLink]="[
                  '/drif-projects',
                  projectId,
                  'interim-reports',
                  report.id
                ]"
                >{{ report.id }}</a
              >
            </td>
          </ng-container>
          <ng-container matColumnDef="dueDate">
            <th mat-header-cell *matHeaderCellDef>Due Date</th>
            <td mat-cell *matCellDef="let report">{{ report.dueDate }}</td>
          </ng-container>
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let report">{{ report.status }}</td>
          </ng-container>
          <tr
            mat-header-row
            *matHeaderRowDef="['id', 'dueDate', 'status']"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: ['id', 'dueDate', 'status']"
          ></tr>
        </table>
      </mat-card>
    </mat-tab>
  </mat-tab-group>
</div>
