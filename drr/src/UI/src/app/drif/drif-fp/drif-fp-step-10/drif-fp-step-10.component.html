<div class="drr-step-container" *transloco="let t">
  <form [formGroup]="budgetForm">
    <mat-label class="drr-label">DRIF Program Funding Breakdown</mat-label>
    <p>
      Let's review the total funding you are requesting from the DRIF program.
    </p>
    <p>
      Based on your EOI, your eligible DRIF program funding is:
      {{ budgetForm.get("eligibleFundingRequest")?.value | currency }}
    </p>

    <p>
      The amount of funding you need may have changed since you submitted your
      EOI for various reasons, including changes to the scope of your project or
      more precise estimates. Use the fields below to provide a year-over-year
      breakdown of your updated DRIF program funding request. If this total
      differs from the eligible amount in your EOI, you will be asked to
      explain.
    </p>

    <p>
      Ensure that these numbers align with your Detailed Cost Estimate, which
      you will attach on Step 11 of this form. Note that the fiscal year runs
      from April 1 - Mar 31.
    </p>

    <div>
      <div
        class="array-item-container"
        *ngFor="
          let funding of getFormArray('yearOverYearFunding').controls;
          let i = index
        "
      >
        <drr-select
          [label]="t('fiscalYear')"
          [rxFormControl]="funding.get('year')"
          [options]="fiscalYearsOptions"
        ></drr-select>
        <drr-currency-input
          [label]="t('amount')"
          [rxFormControl]="funding.get('amount')"
          [max]="1000000000"
        ></drr-currency-input>
        @if (i > 0) {
        <button mat-mini-fab color="warn" (click)="removeYear(i)">
          <mat-icon>delete</mat-icon></button
        >}
      </div>
      <button
        style="margin-top: 10px"
        [style.padding]="isMobile ? '24px 16px' : ''"
        mat-stroked-button
        type="button"
        color="primary"
        (click)="addYear()"
      >
        <mat-icon>add</mat-icon>
        {{ t("addYear") }}
      </button>
    </div>

    <p [style.color]="isTotalDrifFundingRequestInvalid() ? 'red' : 'initial'">
      Your updated DRIF program funding request is:
      {{ budgetForm.get("totalDrifFundingRequest")?.value | currency }}
    </p>
    @if (isTotalDrifFundingRequestInvalid()) {
    <p style="color: red">
      This value must be less than
      {{ "1000000000" | currency : "" : "symbol" : "1.0-0" }}
    </p>
    }

    <div *ngIf="showDiscrepancyComment()" style="margin-top: 1rem">
      <drr-textarea
        [label]="t('discrepancyComment')"
        [maxlength]="2000"
        [rxFormControl]="budgetForm.get('discrepancyComment')"
      ></drr-textarea>
    </div>

    <mat-divider style="margin: 2rem 0"></mat-divider>

    <mat-label class="drr-label">Total Project Cost Breakdown</mat-label>
    <p>
      Let's review the total cost for your project, including funding sources
      outside of the DRIF program. The total costs for your project may also
      have changed since you submitted your EOI. The values below were copied
      from your EOI, but you can update them as needed.
    </p>
    <drr-currency-input
      [id]="'totalProjectCost'"
      class="drr-single-input"
      [label]="t('totalProjectCost')"
      [rxFormControl]="budgetForm.get('totalProjectCost')"
    ></drr-currency-input>

    <p [style.color]="isTotalDrifFundingRequestInvalid() ? 'red' : 'initial'">
      Your updated DRIF program funding request is:
      {{ budgetForm.get("totalDrifFundingRequest")?.value | currency }}
    </p>
    @if (isTotalDrifFundingRequestInvalid()) {
    <p style="color: red">
      This value must be less than
      {{ "1000000000" | currency : "" : "symbol" : "1.0-0" }}
    </p>
    }

    <mat-label class="drr-label" style="margin-top: 1rem">{{
      t("otherFunding")
    }}</mat-label>
    <drr-radio-button
      [label]="t('haveOtherFunding')"
      [rxFormControl]="budgetForm.get('haveOtherFunding')"
    ></drr-radio-button>

    @if (budgetForm.get('haveOtherFunding')?.value === true) {
    <drr-funding-list
      [fundingFormArray]="getFormArray('otherFunding')"
    ></drr-funding-list>
    }

    <mat-label class="drr-label" style="margin-top: 2rem">{{
      getRemainingAmount() > 0
        ? t("missingFundsLabel")
        : t("excessFundingLabel")
    }}</mat-label>
    <mat-label [style.color]="getRemainingAmount() < 0 ? 'red' : 'initial'">{{
      getRemainingAmountAbs() | currency
    }}</mat-label>
    <mat-hint *ngIf="getRemainingAmount() < 0" style="color: red">{{
      t("excessFundingTextFp")
    }}</mat-hint>
    <mat-hint *ngIf="getRemainingAmount() == 0">{{
      t("noExcessFundingText")
    }}</mat-hint>

    <drr-textarea
      *ngIf="getRemainingAmount() > 0"
      style="margin-top: 10px"
      [id]="'intendToSecureFunding'"
      [label]="t('intendToSecureFunding')"
      [maxlength]="2000"
      [rxFormControl]="budgetForm.get('intendToSecureFunding')"
    ></drr-textarea>

    <mat-divider style="margin: 2rem 0"></mat-divider>

    <mat-label class="drr-label" style="margin-top: 1rem">{{
      t("costEffective")
    }}</mat-label>
    <drr-textarea
      [label]="t('costEffectiveComments')"
      [rxFormControl]="budgetForm.get('costEffectiveComments')"
      [maxlength]="2000"
    ></drr-textarea>

    <mat-label class="drr-label">{{ t("previousResponse") }}</mat-label>
    <drr-radio-button
      [label]="t('previousResponseQuestion')"
      [rxFormControl]="budgetForm.get('previousResponse')"
      [options]="previousResponseOptions"
    ></drr-radio-button>
    <drr-currency-input
      *ngIf="budgetForm.get('previousResponse')?.value === 'Yes'"
      [label]="t('previousResponseCost')"
      [rxFormControl]="budgetForm.get('previousResponseCost')"
    ></drr-currency-input>
    <drr-textarea
      *ngIf="
        budgetForm.get('previousResponse')?.value === 'Yes' ||
        budgetForm.get('previousResponse')?.value === 'NotApplicable'
      "
      [label]="t('previousResponseComments')"
      [rxFormControl]="budgetForm.get('previousResponseComments')"
      [maxlength]="2000"
    ></drr-textarea>

    <mat-label class="drr-label">{{ t("costConsiderations") }}</mat-label>
    <drr-radio-button
      [label]="t('costConsiderationsApplied')"
      [rxFormControl]="budgetForm.get('costConsiderationsApplied')"
    ></drr-radio-button>
    <drr-chip-autocomplete
      *ngIf="budgetForm.get('costConsiderationsApplied')?.value === true"
      [label]="t('costConsiderationsQuestions')"
      [placeholder]="t('autocompletePlaceholder')"
      [rxFormControl]="budgetForm.get('costConsiderations')"
      [options]="costConsiderationsOptions"
    ></drr-chip-autocomplete>
    <drr-textarea
      [label]="t('costConsiderationsComments')"
      [rxFormControl]="budgetForm.get('costConsiderationsComments')"
      [maxlength]="2000"
    ></drr-textarea>

    <mat-label class="drr-label">Detailed Cost Estimates</mat-label>
    <p>
      Use the section below to provide a detailed breakdown of the costs
      estimates for each high-level task in your project. You can add as many
      rows as needed. We will use this breakdown when you report your progress.
    </p>
    <p>Please note:</p>
    <ul>
      <li>
        Your total costs must match the updated DRIF funding request in the
        <b>DRIF Program Funding Breakdown</b> above.
      </li>
      <li>
        Administrative costs cannot exceed 10% of the approved DRIF program
        cost.
      </li>
      <li>
        If you choose “other” for any of the values, use the description field
        to explain.
      </li>
      @if (isStrucutralProject()) {
      <li>
        At this stage, your project should have a class A or B cost estimate.
        Set your contingency based on this. See below for more information about
        the classes.
      </li>
      }
    </ul>
    <div>
      <div
        *ngFor="
          let cost of getFormArray('costEstimates').controls;
          let i = index
        "
      >
        <mat-card style="margin-top: 1rem">
          <mat-card-header>
            <mat-card-subtitle>Task {{ i + 1 }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="row">
              <drr-input
                label="Task Name"
                [rxFormControl]="cost.get('taskName')"
                [maxlength]="50"
              ></drr-input>
              <drr-select
                label="Cost Category"
                [rxFormControl]="cost.get('costCategory')"
                [options]="costCategoriesOptions"
              >
              </drr-select>
            </div>
            <drr-textarea
              label="Description"
              [rxFormControl]="cost.get('description')"
              [maxlength]="500"
            ></drr-textarea>
            <div class="row">
              <drr-select
                label="Resources"
                [rxFormControl]="cost.get('resources')"
                [options]="resourcesOptions"
              ></drr-select>
              <drr-select
                label="Units"
                [rxFormControl]="cost.get('units')"
                [options]="unitsOptions"
              >
              </drr-select>
              <drr-input
                label="Quantity"
                [rxFormControl]="cost.get('quantity')"
                [type]="'number'"
              ></drr-input>
              <drr-currency-input
                label="Unit Rate"
                [rxFormControl]="cost.get('unitRate')"
                [max]="1000000000"
              ></drr-currency-input>
              <drr-currency-input
                label="Total Cost"
                [rxFormControl]="cost.get('totalCost')"
                [disabled]="true"
              ></drr-currency-input>
            </div>
            <div class="row"></div>
          </mat-card-content>
          @if (i > 0) {
          <mat-card-actions align="end">
            <button mat-raised-button color="warn" (click)="removeCost(i)">
              Remove
            </button>
          </mat-card-actions>
          }
        </mat-card>
      </div>
      <button
        style="margin-top: 10px"
        [style.padding]="isMobile ? '24px 16px' : ''"
        mat-stroked-button
        type="button"
        color="primary"
        (click)="addCost()"
      >
        <mat-icon>add</mat-icon>
        Add Additional Task
      </button>
    </div>
  </form>
</div>
